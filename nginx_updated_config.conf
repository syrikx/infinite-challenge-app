map $http_upgrade $connection_upgrade {
        default upgrade;
#        '' close;
}
upstream websocket {
        server localhost:8010;
}
upstream vue {
	server localhost:5173;
}
upstream lfc {
	server localhost:5200;
}
upstream raou {
	server localhost:5000;
}
upstream video {
        server localhost:7001;
}
upstream fr_udonginga{
	server localhost:5174;
}
upstream cryptovol{
	server localhost:3003;
}
upstream back_cryptovol{
        server localhost:3004;
}
upstream back_udonginga{
	server localhost:3002;
}
upstream backend {
	server localhost:3001;
}
upstream backend-sino {
	server localhost:4001;
}
upstream back_naver {
        server localhost:3000;
}
upstream back_allele {
        server localhost:3100;
}

upstream fr_naver{
        server localhost:5175;
#	server localhost:3003;
}
upstream pokemug{
	server localhost:3011;
}
upstream hyunakim{
	server localhost:3021;
}
upstream allele{
        server localhost:5174;
}
upstream imac{
        server localhost:2288;
}
upstream map{
	server localhost:2299;
}
upstream youhak {
	server localhost:5000;
}

server {
    server_name mac.gunsiya.com;
    location / {
        proxy_pass http://imac;
    }
}
server {
    server_name map.gunsiya.com;
    location / {
	proxy_pass http://map;
    }
}
 
server {
#    server_name  playfi.site;
    server_name gunsiya.com;
    access_log  /var/log/nginx/host.access.log  main;
    location / {
	proxy_pass http://vue;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }
    location /lfc {
        proxy_pass http://lfc;
    }
    location /imac {
        proxy_pass http://imac/;
	proxy_set_header Host $host;
	proxy_set_header X-Real-IP $remote_addr;
	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /raou {
        proxy_pass http://raou;
    }
    location /video2 {
        proxy_pass http://video;
    }
    location /video/ {
        proxy_pass http://127.0.0.1:7000/;
    }


    location /api {
        proxy_set_header   X-Forwarded-For $remote_addr;
        proxy_set_header   Host $host;
	proxy_pass http://backend;
    }
    location /api-sino {
        proxy_set_header   X-Forwarded-For $remote_addr;
        proxy_set_header   Host $host;
        proxy_pass http://backend-sino;
    }

    location /udonginga/ {
        proxy_set_header   X-Forwarded-For $remote_addr;
        proxy_set_header   Host $host;
	proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_pass http://fr_udonginga;
    }
    location /naver/ {
        proxy_set_header   X-Forwarded-For $remote_addr;
        proxy_set_header   Host $host;
	proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_pass http://fr_naver;
    }
    location /naver/api/ {
        proxy_set_header   X-Forwarded-For $remote_addr;
        proxy_set_header   Host $host;
        proxy_pass http://back_naver/;
    }
    location /allele/api/ {
        proxy_set_header   X-Forwarded-For $remote_addr;
        proxy_set_header   Host $host;
        proxy_pass http://back_allele/;
    }

    location /udonginga/api/ {
        proxy_set_header   X-Forwarded-For $remote_addr;
        proxy_set_header   Host $host;
        proxy_pass http://back_udonginga/;
    }
    location /cryptovol/ {
	proxy_set_header   X-forwarded-For $remote_addr;
	proxy_set_header   Host $host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
	proxy_pass http://cryptovol;
    }
    location /cryptovol/api/ {
        proxy_set_header   X-forwarded-For $remote_addr;
        proxy_set_header   Host $host;
        proxy_pass http://back_cryptovol/;
    }
    location /pokemug/ {
        proxy_set_header   X-forwarded-For $remote_addr;
        proxy_set_header   Host $host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_pass http://pokemug;
    }
    location /hyunakim/ {
        proxy_set_header   X-forwarded-For $remote_addr;
        proxy_set_header   Host $host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_pass http://hyunakim;
    }
    location /allele/ {
        proxy_set_header   X-forwarded-For $remote_addr;
        proxy_set_header   Host $host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_pass http://allele;
    }
    location /youhak/ {
        proxy_set_header   X-Forwarded-For $remote_addr;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_pass http://youhak/;
    }
    location /ws/ {
    	rewrite ^/ws/?(.*)$ /$1 break;  # "/ws" 경로를 제거하고 넘김
    	proxy_pass http://localhost:3000;

    	proxy_http_version 1.1;
    	proxy_set_header Upgrade $http_upgrade;
    	proxy_set_header Connection "upgrade";

    	proxy_set_header Host $host;
    	proxy_set_header X-Real-IP $remote_addr;
    	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }


    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/gunsiya.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/gunsiya.com/privkey.pem; # managed by Certbot
#    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
#    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}
server {
#	listen 8020 ssl;
#        ssl_certificate /etc/letsencrypt/live/playfi.site/fullchain.pem; # managed by Certbot
#        ssl_certificate_key /etc/letsencrypt/live/playfi.site/privkey.pem; # managed by Certbot
#        include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
#        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
#	location ^~ /ws/{
#	rewrite ^/(ws)/(.*)$ /$2 break;
#                proxy_pass http://websocket;
#                proxy_http_version 1.1;
#            proxy_set_header Upgrade $http_upgrade;
#            proxy_set_header Connection $connection_upgrade;
#            proxy_set_header Host $host;
#	}
	location / {
		proxy_pass http://websocket;
#		proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
#            proxy_set_header Host $host;
	}
#	location /wsapp/ {
#	    proxy_pass http://websocket;
#	    proxy_http_version 1.1;
#	    proxy_set_header Upgrade $http_upgrade;
#	    proxy_set_header Connection "Upgrade";
#	    proxy_set_header Host $host;
#	}
}
server {
    listen 80;
    server_name gunsiya.com;

    # WebSocket 연결은 리디렉션하지 않고 그냥 연결 끊음
    location /ws/ {
        return 444;  # nginx의 '연결 강제 종료' 상태 코드
    }

    # 나머지는 https로 리디렉션
    location / {
        return 301 https://$host$request_uri;
    }
}
